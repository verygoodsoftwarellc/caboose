<style>
  .code-path {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 13px;
    color: var(--text-secondary);
    background: var(--bg-body);
    padding: 2px 8px;
    border-radius: 4px;
    display: inline-block;
  }

  .action-name {
    font-weight: 600;
    color: var(--text-primary);
  }

  .detail-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 24px;
  }

  .detail-header-left {
    flex: 1;
    min-width: 0;
  }

  .detail-title {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .detail-title h1 {
    font-size: 18px;
    font-weight: 600;
    word-break: break-all;
    color: var(--text-primary);
  }

  .detail-meta {
    display: flex;
    gap: 24px;
    margin-top: 12px;
    flex-wrap: wrap;
  }

  .meta-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .meta-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
  }

  .meta-value {
    font-size: 14px;
    color: var(--text-primary);
    font-weight: 500;
  }

  .meta-value.mono {
    font-family: 'IBM Plex Mono', monospace;
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 0;
  }

  .tab {
    padding: 12px 20px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    text-decoration: none;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all 0.15s ease;
    cursor: pointer;
  }

  .tab:hover {
    color: var(--text-primary);
    text-decoration: none;
  }

  .tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }

  .tab-content {
    display: none;
    padding: 20px;
  }

  .tab-content.active {
    display: block;
  }

  /* Details Grid */
  .details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
  }

  .detail-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .detail-label {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
  }

  .detail-value {
    font-size: 14px;
    color: var(--text-primary);
    word-break: break-all;
  }

  /* Waterfall */
  .waterfall {
    display: flex;
    flex-direction: column;
    gap: 1px;
  }

  .waterfall-header {
    display: flex;
    justify-content: space-between;
    padding: 8px 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
    margin-bottom: 4px;
  }

  .waterfall-row {
    padding: 0 12px;
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.1s ease;
  }

  .waterfall-row:hover .waterfall-bar-container {
    background: #cbd5e1;
  }

  .waterfall-row.selected {
    /* No background change on selection */
  }

  .waterfall-bar-container {
    height: 31px;
    background: var(--border);
    border-radius: 4px;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .waterfall-label {
    position: relative;
    z-index: 1;
    font-size: 12px;
    color: var(--text-primary);
    font-family: 'IBM Plex Mono', monospace;
    padding: 2px 8px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    background: rgba(255, 255, 255, 0.4);
    border-radius: 3px;
    margin-left: 4px;
  }

  .waterfall-bar {
    position: absolute;
    height: 100%;
    border-radius: 4px;
    min-width: 3px;
    opacity: 0.9;
    transition: opacity 0.15s ease;
  }

  .waterfall-bar:hover {
    opacity: 1;
  }

  .waterfall-bar.sql { background: #3b82f6; }
  .waterfall-bar.cache { background: #22c55e; }
  .waterfall-bar.view { background: #f59e0b; }
  .waterfall-bar.http { background: #a855f7; }
  .waterfall-bar.mailer { background: #ec4899; }
  .waterfall-bar.job { background: #06b6d4; }
  .waterfall-bar.other { background: #bec9d7; }

  .waterfall-duration {
    position: relative;
    z-index: 1;
    font-size: 12px;
    color: var(--text-primary);
    font-variant-numeric: tabular-nums;
    font-family: 'IBM Plex Mono', monospace;
    background: rgba(255, 255, 255, 0.4);
    border-radius: 3px;
    padding: 2px 8px;
    margin-right: 4px;
    flex-shrink: 0;
  }

  .clue-detail {
    display: none;
    margin: 0 12px 8px 24px;
    padding: 12px 16px;
    background: var(--bg-code);
    border-radius: 4px 8px 8px 4px;
    font-size: 13px;
    border-left: 3px solid var(--border);
  }

  .clue-detail.visible {
    display: block;
  }

  .clue-detail.sql { border-left-color: #3b82f6; }
  .clue-detail.cache { border-left-color: #22c55e; }
  .clue-detail.view { border-left-color: #f59e0b; }
  .clue-detail.http { border-left-color: #a855f7; }
  .clue-detail.mailer { border-left-color: #ec4899; }
  .clue-detail.job { border-left-color: #06b6d4; }
  .clue-detail.other { border-left-color: #bec9d7; }

  .clue-detail pre {
    margin: 0;
    padding: 0;
    background: transparent;
    white-space: pre-wrap;
    word-break: break-all;
  }

  /* Legend */
  .legend {
    display: flex;
    gap: 0;
    flex-wrap: wrap;
    padding: 12px 20px;
    background: var(--bg-body);
    border-bottom: 1px solid var(--border);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--text-secondary);
  }

  .legend-color {
    width: 14px;
    height: 14px;
    border-radius: 4px;
  }

  .legend-color.sql { background: #3b82f6; }
  .legend-color.cache { background: #22c55e; }
  .legend-color.view { background: #f59e0b; }
  .legend-color.http { background: #a855f7; }
  .legend-color.mailer { background: #ec4899; }
  .legend-color.job { background: #06b6d4; }
  .legend-color.other { background: #bec9d7; }

  .empty-clues {
    text-align: center;
    padding: 48px 20px;
    color: var(--text-secondary);
  }

  .empty-clues svg {
    width: 40px;
    height: 40px;
    margin-bottom: 12px;
    color: var(--text-muted);
  }

  /* Clickable legend */
  .legend-item.clickable {
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 6px;
    transition: all 0.15s ease;
  }

  .legend-item.clickable:hover {
    background: var(--bg-hover);
  }

  .legend-item.clickable.active {
    background: var(--accent);
    color: white;
  }

  .legend-color.all {
    background: linear-gradient(135deg, #3b82f6 0%, #22c55e 25%, #f59e0b 50%, #a855f7 75%, #64748b 100%);
  }

  .waterfall-row.hidden {
    display: none;
  }

  .clue-detail.hidden-by-filter {
    display: none !important;
  }

  .copy-ai-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
    background: var(--bg-body);
    border: 1px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .copy-ai-btn:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
    border-color: var(--text-muted);
  }

  .copy-ai-btn.copied {
    background: #22c55e;
    color: white;
    border-color: #22c55e;
  }
</style>

<div class="page-header">
  <div class="detail-header">
    <div class="detail-header-left">
      <div class="detail-title">
        <% if @case[:type] == "request" %>
          <% method = @case[:content]["method"] || @case[:name].to_s.split(" ").first || "GET" %>
          <span class="badge badge-<%= method.downcase %>"><%= method %></span>
        <% else %>
          <span class="badge badge-job">JOB</span>
        <% end %>
        <% status_class = case @case[:status].to_s
           when /^2/, "completed" then "success"
           when /^[45]/, "failed" then "error"
           when /^3/ then "warning"
           else "warning"
           end %>
        <span class="badge badge-status badge-<%= status_class %>"><%= @case[:status] %></span>
        <h1><%= @case[:name] %></h1>
      </div>
      <div class="detail-meta">
        <div class="meta-item">
          <span class="meta-label">Duration</span>
          <span class="meta-value mono"><%= format_duration(@case[:duration_ms]) %></span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Time</span>
          <span class="meta-value"><%= @case[:started_at]&.strftime("%b %d, %Y %H:%M:%S") %></span>
        </div>
        <% if @case[:parent_case_uuid] && @parent_case %>
          <div class="meta-item">
            <span class="meta-label">Triggered by</span>
            <span class="meta-value"><%= link_to @parent_case[:name], case_path(@parent_case[:uuid]), style: "color: var(--accent);" %></span>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="card">
    <div class="tabs">
      <a class="tab active" onclick="showTab('timeline')">Timeline (<%= @clues.size %>)</a>
      <a class="tab" onclick="showTab('details')">Details</a>
      <% if @case[:content].present? && @case[:content]["params"].present? %>
        <a class="tab" onclick="showTab('payload')">Payload</a>
      <% end %>
    </div>

    <div id="tab-details" class="tab-content">
      <% if @case[:content].present? && @case[:content].any? %>
        <div class="details-grid">
          <% @case[:content].each do |key, value| %>
            <% next if value.is_a?(Hash) || value.is_a?(Array) %>
            <% next if %w[user_agent remote_addr].include?(key.to_s) %>
            <div class="detail-item">
              <span class="detail-label"><%= key.to_s.titleize %></span>
              <span class="detail-value"><%= value %></span>
            </div>
          <% end %>
        </div>

        <% nested = @case[:content].reject { |k, v| !v.is_a?(Hash) && !v.is_a?(Array) }.reject { |k, _| k.to_s == "params" } %>
        <% if nested.any? %>
          <% nested.each do |key, value| %>
            <div style="margin-top: 24px;">
              <span class="detail-label"><%= key.to_s.titleize %></span>
              <pre style="margin-top: 8px;"><code><%= format_content(value) %></code></pre>
            </div>
          <% end %>
        <% end %>
      <% else %>
        <div class="empty-clues">
          <p>No details recorded.</p>
        </div>
      <% end %>
    </div>

    <div id="tab-timeline" class="tab-content active">
      <% if @clues.blank? %>
        <div class="empty-clues">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          <p>No timeline events recorded for this case.</p>
        </div>
      <% else %>
        <%
          clue_counts = @clues.each_with_object(Hash.new(0)) do |clue, counts|
            category = case clue[:type]
              when /instantiation\.active_record/ then "other"
              when /sql|active_record/ then "sql"
              when /cache/ then "cache"
              when /render|view/ then "view"
              when /http|request/ then "http"
              when /mail/ then "mailer"
              when /job|perform/ then "job"
              else "other"
            end
            counts[category] += 1
          end
        %>
        <div class="legend">
          <div class="legend-item clickable active" data-filter="all" onclick="filterClues('all')"><div class="legend-color all"></div> All (<%= @clues.size %>)</div>
          <% if clue_counts["sql"] > 0 %><div class="legend-item clickable" data-filter="sql" onclick="filterClues('sql')"><div class="legend-color sql"></div> SQL (<%= clue_counts["sql"] %>)</div><% end %>
          <% if clue_counts["cache"] > 0 %><div class="legend-item clickable" data-filter="cache" onclick="filterClues('cache')"><div class="legend-color cache"></div> Cache (<%= clue_counts["cache"] %>)</div><% end %>
          <% if clue_counts["view"] > 0 %><div class="legend-item clickable" data-filter="view" onclick="filterClues('view')"><div class="legend-color view"></div> View (<%= clue_counts["view"] %>)</div><% end %>
          <% if clue_counts["http"] > 0 %><div class="legend-item clickable" data-filter="http" onclick="filterClues('http')"><div class="legend-color http"></div> HTTP (<%= clue_counts["http"] %>)</div><% end %>
          <% if clue_counts["mailer"] > 0 %><div class="legend-item clickable" data-filter="mailer" onclick="filterClues('mailer')"><div class="legend-color mailer"></div> Mailer (<%= clue_counts["mailer"] %>)</div><% end %>
          <% if clue_counts["job"] > 0 %><div class="legend-item clickable" data-filter="job" onclick="filterClues('job')"><div class="legend-color job"></div> Job (<%= clue_counts["job"] %>)</div><% end %>
          <% if clue_counts["other"] > 0 %><div class="legend-item clickable" data-filter="other" onclick="filterClues('other')"><div class="legend-color other"></div> Other (<%= clue_counts["other"] %>)</div><% end %>
          <div style="margin-left: auto; display: flex; gap: 8px;">
            <button type="button" onclick="collapseAll()" class="copy-ai-btn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="4 14 10 14 10 20"></polyline>
                <polyline points="20 10 14 10 14 4"></polyline>
                <line x1="14" y1="10" x2="21" y2="3"></line>
                <line x1="3" y1="21" x2="10" y2="14"></line>
              </svg>
              Collapse All
            </button>
            <button type="button" onclick="copyForAI()" class="copy-ai-btn" id="copy-ai-btn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              Copy for AI
            </button>
          </div>
        </div>

        <div style="padding: 12px;">
          <div class="waterfall-header">
            <div>Event</div>
            <div>Duration</div>
          </div>

          <div class="waterfall">
            <% total_duration = [@case[:duration_ms] || 1, 1].max %>
            <% @clues.each_with_index do |clue, index| %>
              <%
                left = ((clue[:started_at_offset_ms] || 0) / total_duration * 100).clamp(0, 99.5)
                width = ((clue[:duration_ms] || 0) / total_duration * 100).clamp(0.5, [0.5, 100 - left].max)

                bar_class = case clue[:type]
                when /instantiation\.active_record/ then "other"
                when /sql|active_record/ then "sql"
                when /cache/ then "cache"
                when /render|view/ then "view"
                when /http|request/ then "http"
                when /mail/ then "mailer"
                when /job|perform/ then "job"
                else "other"
                end
              %>
              <div class="waterfall-row" onclick="toggleClue(<%= index %>)" id="row-<%= index %>" data-clue-type="<%= bar_class %>">
                <%
                  display_name = if clue[:type] == "instantiation.active_record" && clue[:content]["class_name"]
                    count = clue[:content]["record_count"]
                    "#{clue[:content]["class_name"]} Instantiation (#{count})"
                  elsif clue[:type] =~ /^render_(template|partial|collection|layout)\.action_view$/ && clue[:content]["identifier"]
                    path = clue[:content]["identifier"]
                    # Remove Rails.root prefix if present
                    path = path.sub(/^#{Regexp.escape(Rails.root.to_s)}\//, "")
                    # Remove app/views/ prefix if present
                    path = path.sub(/^app\/views\//, "")
                    path
                  elsif clue[:type] =~ /middleware/ && clue[:content]["middleware"]
                    clue[:content]["middleware"]
                  elsif clue[:type] == "process_action.action_controller" && clue[:content]["controller"]
                    "#{clue[:content]["controller"]}##{clue[:content]["action"]}"
                  else
                    clue[:content]["name"].presence || clue[:type]
                  end
                %>
                <div class="waterfall-bar-container">
                  <div class="waterfall-bar <%= bar_class %>" style="left: <%= left %>%; width: <%= width %>%;"></div>
                  <span class="waterfall-label" title="<%= display_name %>"><%= display_name %></span>
                  <span class="waterfall-duration"><%= format_duration(clue[:duration_ms]) %></span>
                </div>
              </div>
              <div class="clue-detail <%= bar_class %>" id="clue-<%= index %>">
                <pre><code><%= format_content(clue[:content]) %></code></pre>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <% if @case[:content].present? && @case[:content]["params"].present? %>
      <div id="tab-payload" class="tab-content">
        <pre style="margin: 20px;"><code><%= format_content(@case[:content]["params"]) %></code></pre>
      </div>
    <% end %>
  </div>
</div>

<script>
  // Data for Copy for AI feature
  const caseData = <%= {
    type: @case[:type],
    name: @case[:name],
    status: @case[:status],
    duration_ms: @case[:duration_ms],
    method: @case[:content]&.dig("method"),
    path: @case[:content]&.dig("path"),
    controller: @case[:content]&.dig("controller"),
    action: @case[:content]&.dig("action"),
    params: @case[:content]&.dig("params"),
    format: @case[:content]&.dig("format"),
    db_runtime: @case[:content]&.dig("db_runtime"),
    view_runtime: @case[:content]&.dig("view_runtime")
  }.to_json.html_safe %>;

  const cluesData = <%= @clues.map { |clue|
    {
      type: clue[:type],
      duration_ms: clue[:duration_ms],
      started_at_offset_ms: clue[:started_at_offset_ms],
      content: clue[:content]
    }
  }.to_json.html_safe %>;

  function formatDuration(ms) {
    if (ms === null || ms === undefined) return '0ms';
    if (ms >= 1000) return (ms / 1000).toFixed(2) + 's';
    return ms.toFixed(2) + 'ms';
  }

  function copyForAI() {
    let output = [];

    // AI prompt
    const traceType = caseData.type === 'job' ? 'job' : 'request';
    output.push(`> Given this Rails ${traceType} trace, how would you improve performance? What information is missing that would help diagnose issues?`);
    output.push('');

    // Header with case info
    const method = caseData.method || 'GET';
    const status = caseData.status || '200';
    output.push(`# ${method} ${caseData.name} [${status}] - ${formatDuration(caseData.duration_ms)}`);
    if (caseData.controller && caseData.action) {
      output.push(`Controller: ${caseData.controller}#${caseData.action}`);
    }
    output.push('');

    // Request Context
    output.push('## Request Context');
    output.push('');

    // Show params if present (filter out common noise)
    if (caseData.params && Object.keys(caseData.params).length > 0) {
      const filteredParams = Object.entries(caseData.params)
        .filter(([k, v]) => !['controller', 'action', 'format'].includes(k))
        .filter(([k, v]) => v !== null && v !== undefined && v !== '');
      if (filteredParams.length > 0) {
        output.push('**Params:**');
        filteredParams.forEach(([k, v]) => {
          const val = typeof v === 'object' ? JSON.stringify(v) : v;
          output.push(`- ${k}: ${val}`);
        });
        output.push('');
      }
    }

    // Infer data sizes from AR instantiation events
    const instantiations = cluesData.filter(c => c.type === 'instantiation.active_record');
    if (instantiations.length > 0) {
      output.push('**Data loaded (from AR instantiation):**');
      // Group by class name and sum record counts
      const classRecords = {};
      instantiations.forEach(clue => {
        const className = clue.content?.class_name || 'Unknown';
        const count = clue.content?.record_count || 0;
        if (!classRecords[className]) {
          classRecords[className] = { count: 0, loads: 0 };
        }
        classRecords[className].count += count;
        classRecords[className].loads++;
      });
      // Sort by count descending
      Object.entries(classRecords)
        .sort((a, b) => b[1].count - a[1].count)
        .forEach(([className, data]) => {
          const loadsInfo = data.loads > 1 ? ` (${data.loads} loads)` : '';
          output.push(`- ${className}: ${data.count} records${loadsInfo}`);
        });
      output.push('');
    }

    // Performance Summary
    output.push('## Performance Summary');
    output.push('');
    output.push(`- **Total:** ${formatDuration(caseData.duration_ms)}`);

    // SQL stats
    const sqlClues = cluesData.filter(c => c.type === 'sql.active_record');
    if (sqlClues.length > 0) {
      const sqlTotalMs = sqlClues.reduce((sum, c) => sum + (c.duration_ms || 0), 0);
      output.push(`- **SQL:** ${sqlClues.length} queries, ${formatDuration(sqlTotalMs)} total`);

      // Detect N+1 queries by grouping similar queries
      const queryGroups = {};
      sqlClues.forEach(clue => {
        const content = clue.content || {};
        // Normalize the query by removing specific values to group similar queries
        let sql = (content.sql || '').trim();
        // Replace specific IDs/values with ? for grouping
        const normalized = sql
          .replace(/= \d+/g, '= ?')
          .replace(/IN \([^)]+\)/gi, 'IN (?)')
          .replace(/'[^']*'/g, '?')
          .replace(/\d{4}-\d{2}-\d{2}[T\s]\d{2}:\d{2}:\d{2}[^'"]*/g, '?');

        const key = (content.name || '') + '::' + normalized;
        if (!queryGroups[key]) {
          queryGroups[key] = { name: content.name || 'Query', sql: sql, count: 0, totalMs: 0 };
        }
        queryGroups[key].count++;
        queryGroups[key].totalMs += clue.duration_ms || 0;
      });

      // Find likely N+1s (3+ identical queries)
      const n1Candidates = Object.values(queryGroups)
        .filter(g => g.count >= 3)
        .sort((a, b) => b.count - a.count);

      if (n1Candidates.length > 0) {
        const n1List = n1Candidates
          .slice(0, 5)
          .map(g => `${g.name || 'Query'} (${g.count}x, ${formatDuration(g.totalMs)})`)
          .join(', ');
        output.push(`- **Likely N+1:** ${n1List}`);
      }

      // Slowest queries
      const slowest = [...sqlClues]
        .sort((a, b) => (b.duration_ms || 0) - (a.duration_ms || 0))
        .slice(0, 3);
      if (slowest.length > 0 && slowest[0].duration_ms > 1) {
        const slowList = slowest
          .map(c => `${c.content?.name || 'Query'} (${formatDuration(c.duration_ms)})`)
          .join(', ');
        output.push(`- **Slowest queries:** ${slowList}`);
      }
    }

    // View rendering stats
    const viewClues = cluesData.filter(c => c.type.match(/^render_(template|partial|collection)\.action_view$/));
    if (viewClues.length > 0) {
      const viewTotalMs = viewClues.reduce((sum, c) => sum + (c.duration_ms || 0), 0);
      const partials = viewClues.filter(c => c.type.includes('partial'));
      const collections = viewClues.filter(c => c.type.includes('collection'));
      let viewSummary = `- **Views:** ${viewClues.length} renders, ${formatDuration(viewTotalMs)} total`;
      if (partials.length > 0) viewSummary += ` (${partials.length} partials)`;
      if (collections.length > 0) viewSummary += ` (${collections.length} collections)`;
      output.push(viewSummary);

      // Find slowest view
      const slowestView = [...viewClues].sort((a, b) => (b.duration_ms || 0) - (a.duration_ms || 0))[0];
      if (slowestView && slowestView.duration_ms > 5) {
        const path = (slowestView.content?.identifier || '').replace(/.*\/app\/views\//, '');
        output.push(`- **Slowest view:** ${path} (${formatDuration(slowestView.duration_ms)})`);
      }
    }

    output.push('');

    // Timeline
    output.push('## Timeline');
    output.push('');

    cluesData.forEach((clue, idx) => {
      const offset = formatDuration(clue.started_at_offset_ms);
      const duration = formatDuration(clue.duration_ms);
      const content = clue.content || {};

      // Determine display name and extra info based on type
      let name = '';
      let extra = '';

      if (clue.type === 'sql.active_record') {
        name = 'SQL';
        const sql = content.sql || '';
        const queryName = content.name || '';
        extra = queryName ? `[${queryName}] ${sql}` : sql;
      } else if (clue.type === 'instantiation.active_record') {
        name = `${content.class_name || 'AR'} Instantiation (${content.record_count || 0})`;
      } else if (clue.type.match(/^render_(template|partial|collection)\.action_view$/)) {
        const identifier = content.identifier || '';
        // Clean up the path
        let path = identifier.replace(/.*\/app\/views\//, '');
        name = clue.type.replace('.action_view', '').replace('render_', '');
        extra = path;
      } else if (clue.type.includes('middleware')) {
        name = 'Middleware';
        extra = content.middleware || content.name || '';
      } else if (clue.type === 'process_action.action_controller') {
        name = 'Controller';
        extra = `${content.controller}#${content.action}`;
      } else if (clue.type.match(/cache/)) {
        name = 'Cache';
        extra = content.key || content.name || '';
      } else {
        name = clue.type;
        extra = content.name || '';
      }

      // Format the line
      let line = `${offset.padStart(8)} | ${duration.padStart(8)} | ${name}`;
      if (extra) {
        line += `: ${extra}`;
      }
      output.push(line);
    });

    // SQL Summary - grouped by query to deduplicate N+1s (reuse sqlClues from above)
    if (sqlClues.length > 0) {
      output.push('');
      output.push('## SQL Queries');
      output.push('');

      // Group identical queries
      const queryGroupsForList = {};
      sqlClues.forEach(clue => {
        const content = clue.content || {};
        const sql = (content.sql || '').trim();
        const name = content.name || '';
        // Use exact SQL for grouping (not normalized)
        const key = name + '::' + sql;
        if (!queryGroupsForList[key]) {
          queryGroupsForList[key] = { name, sql, count: 0, totalMs: 0, callers: [] };
        }
        queryGroupsForList[key].count++;
        queryGroupsForList[key].totalMs += clue.duration_ms || 0;
        // Capture caller info (first one found)
        if (content.caller && queryGroupsForList[key].callers.length < 3) {
          const callerStr = Array.isArray(content.caller) ? content.caller[0] : content.caller;
          if (callerStr && !queryGroupsForList[key].callers.includes(callerStr)) {
            queryGroupsForList[key].callers.push(callerStr);
          }
        }
      });

      // Sort by total time descending
      const sortedGroups = Object.values(queryGroupsForList)
        .sort((a, b) => b.totalMs - a.totalMs);

      sortedGroups.forEach((group, idx) => {
        const countInfo = group.count > 1 ? `${group.count}x, ` : '';
        output.push(`${idx + 1}. [${countInfo}${formatDuration(group.totalMs)}]${group.name ? ' ' + group.name : ''}`);
        output.push('   ' + group.sql);
        // Show caller location if available (especially useful for N+1s)
        if (group.callers.length > 0) {
          output.push('   Called from: ' + group.callers[0]);
        }
        output.push('');
      });
    }

    // Views/Partials Summary (reuse viewClues from above)
    if (viewClues.length > 0) {
      output.push('## Views/Partials');
      output.push('');
      viewClues.forEach((clue) => {
        const content = clue.content || {};
        const identifier = content.identifier || '';
        let path = identifier.replace(/.*\/app\/views\//, '');
        const duration = formatDuration(clue.duration_ms);
        const type = clue.type.replace('.action_view', '').replace('render_', '');
        output.push(`- [${duration}] ${type}: ${path}`);
      });
      output.push('');
    }

    const text = output.join('\n');

    navigator.clipboard.writeText(text).then(() => {
      const btn = document.getElementById('copy-ai-btn');
      const originalHTML = btn.innerHTML;
      btn.classList.add('copied');
      btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!';
      setTimeout(() => {
        btn.classList.remove('copied');
        btn.innerHTML = originalHTML;
      }, 2000);
    });
  }

  function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));

    // Show selected tab
    document.getElementById('tab-' + tabName).classList.add('active');
    event.target.classList.add('active');
  }

  function toggleClue(index) {
    const detail = document.getElementById('clue-' + index);
    const row = document.getElementById('row-' + index);

    if (detail.classList.contains('visible')) {
      detail.classList.remove('visible');
      row.classList.remove('selected');
    } else {
      detail.classList.add('visible');
      row.classList.add('selected');
    }
  }

  function collapseAll() {
    document.querySelectorAll('.clue-detail.visible').forEach(el => {
      el.classList.remove('visible');
    });
    document.querySelectorAll('.waterfall-row.selected').forEach(el => {
      el.classList.remove('selected');
    });
  }

  function filterClues(filterType) {
    // Update active state on legend items
    document.querySelectorAll('.legend-item.clickable').forEach(el => {
      el.classList.remove('active');
    });
    document.querySelector('.legend-item[data-filter="' + filterType + '"]').classList.add('active');

    // Show/hide waterfall rows
    document.querySelectorAll('.waterfall-row').forEach(row => {
      const clueType = row.getAttribute('data-clue-type');
      if (filterType === 'all' || clueType === filterType) {
        row.classList.remove('hidden');
      } else {
        row.classList.add('hidden');
        // Also close any expanded detail
        row.classList.remove('selected');
      }
    });

    // Show/hide clue details
    document.querySelectorAll('.clue-detail').forEach(detail => {
      const index = detail.id.replace('clue-', '');
      const row = document.getElementById('row-' + index);
      if (row.classList.contains('hidden')) {
        detail.classList.add('hidden-by-filter');
        detail.classList.remove('visible');
      } else {
        detail.classList.remove('hidden-by-filter');
      }
    });
  }
</script>
