<style>
  .code-path {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 13px;
    color: var(--text-secondary);
    background: var(--bg-body);
    padding: 2px 8px;
    border-radius: 4px;
    display: inline-block;
  }

  .job-name {
    font-weight: 600;
    color: var(--text-primary);
  }

  .detail-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 24px;
  }

  .detail-header-left {
    flex: 1;
    min-width: 0;
  }

  .detail-title {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .detail-title h1 {
    font-size: 18px;
    font-weight: 600;
    word-break: break-all;
    color: var(--text-primary);
  }

  .detail-meta {
    display: flex;
    gap: 24px;
    margin-top: 12px;
    flex-wrap: wrap;
  }

  .meta-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .meta-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
  }

  .meta-value {
    font-size: 14px;
    color: var(--text-primary);
    font-weight: 500;
  }

  .meta-value.mono {
    font-family: 'IBM Plex Mono', monospace;
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 0;
  }

  .tab {
    padding: 12px 20px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    text-decoration: none;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all 0.15s ease;
    cursor: pointer;
  }

  .tab:hover {
    color: var(--text-primary);
    text-decoration: none;
  }

  .tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }

  .tab-content {
    display: none;
    padding: 20px;
  }

  .tab-content.active {
    display: block;
  }

  /* Details - Refined Layout */
  .details-sections {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .details-section {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
  }

  .details-section:last-child {
    border-bottom: none;
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
  }

  .section-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .section-icon svg {
    width: 16px;
    height: 16px;
  }

  .section-icon.job { background: #cffafe; color: #0891b2; }
  .section-icon.queue { background: #f3e8ff; color: #9333ea; }
  .section-icon.other { background: #f1f5f9; color: #64748b; }

  .section-title {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
  }

  .section-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 16px 32px;
  }

  .detail-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .detail-item.full-width {
    grid-column: 1 / -1;
  }

  .detail-label {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-muted);
    letter-spacing: 0.02em;
  }

  .detail-value {
    font-size: 14px;
    color: var(--text-primary);
    word-break: break-word;
    line-height: 1.4;
  }

  .detail-value.mono {
    font-family: 'IBM Plex Mono', ui-monospace, monospace;
    font-size: 13px;
  }

  .detail-value.prominent {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    font-family: 'IBM Plex Mono', ui-monospace, monospace;
  }

  .detail-value.truncate {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .detail-value.secondary {
    color: var(--text-secondary);
    font-size: 13px;
  }

  /* Waterfall */
  .waterfall {
    display: flex;
    flex-direction: column;
    gap: 1px;
  }

  .waterfall-header {
    display: flex;
    justify-content: space-between;
    padding: 8px 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
    margin-bottom: 4px;
  }

  .waterfall-row {
    padding: 0 12px;
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.1s ease;
  }

  #sql-tooltip {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
    background: #1e293b;
    color: #e2e8f0;
    padding: 16px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-family: 'IBM Plex Mono', monospace;
    white-space: pre-wrap;
    word-break: break-all;
    max-width: 600px;
    max-height: 200px;
    overflow: auto;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    pointer-events: none;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.15s ease, visibility 0.15s ease;
  }

  #sql-tooltip.visible {
    opacity: 1;
    visibility: visible;
  }

  .waterfall-row:hover .waterfall-bar-container {
    background: #cbd5e1;
  }

  .waterfall-row.selected {
    /* No background change on selection */
  }

  .waterfall-bar-container {
    height: 31px;
    background: var(--border);
    border-radius: 4px;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .waterfall-label {
    position: relative;
    z-index: 1;
    font-size: 12px;
    color: var(--text-primary);
    font-family: 'IBM Plex Mono', monospace;
    padding: 2px 8px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    background: rgba(255, 255, 255, 0.4);
    border-radius: 3px;
    margin-left: 4px;
  }

  .waterfall-bar {
    position: absolute;
    height: 100%;
    border-radius: 4px;
    min-width: 3px;
    opacity: 0.9;
    transition: opacity 0.15s ease;
  }

  .waterfall-bar:hover {
    opacity: 1;
  }

  .waterfall-bar.sql { background: #3b82f6; }
  .waterfall-bar.cache { background: #22c55e; }
  .waterfall-bar.view { background: #f59e0b; }
  .waterfall-bar.http { background: #a855f7; }
  .waterfall-bar.mailer { background: #ec4899; }
  .waterfall-bar.job { background: #06b6d4; }
  .waterfall-bar.controller { background: #8b5cf6; }
  .waterfall-bar.other { background: #bec9d7; }

  .waterfall-duration {
    position: relative;
    z-index: 1;
    font-size: 12px;
    color: var(--text-primary);
    font-variant-numeric: tabular-nums;
    font-family: 'IBM Plex Mono', monospace;
    background: rgba(255, 255, 255, 0.4);
    border-radius: 3px;
    padding: 2px 8px;
    margin-right: 4px;
    flex-shrink: 0;
  }

  .span-detail {
    display: none;
    margin: 0 12px 8px 24px;
    padding: 12px 16px;
    background: var(--bg-code);
    border-radius: 4px 8px 8px 4px;
    font-size: 13px;
    border-left: 3px solid var(--border);
  }

  .span-detail.visible {
    display: block;
  }

  .span-detail.sql { border-left-color: #3b82f6; }
  .span-detail.cache { border-left-color: #22c55e; }
  .span-detail.view { border-left-color: #f59e0b; }
  .span-detail.http { border-left-color: #a855f7; }
  .span-detail.mailer { border-left-color: #ec4899; }
  .span-detail.job { border-left-color: #06b6d4; }
  .span-detail.controller { border-left-color: #8b5cf6; }
  .span-detail.other { border-left-color: #bec9d7; }

  .span-detail pre {
    margin: 0;
    padding: 0;
    background: transparent;
    white-space: pre-wrap;
    word-break: break-all;
  }

  /* Legend */
  .legend {
    display: flex;
    gap: 0;
    flex-wrap: wrap;
    padding: 12px 20px;
    background: var(--bg-body);
    border-bottom: 1px solid var(--border);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--text-secondary);
  }

  .legend-color {
    width: 14px;
    height: 14px;
    border-radius: 4px;
  }

  .legend-color.sql { background: #3b82f6; }
  .legend-color.cache { background: #22c55e; }
  .legend-color.view { background: #f59e0b; }
  .legend-color.http { background: #a855f7; }
  .legend-color.mailer { background: #ec4899; }
  .legend-color.job { background: #06b6d4; }
  .legend-color.controller { background: #8b5cf6; }
  .legend-color.other { background: #bec9d7; }

  .empty-clues {
    text-align: center;
    padding: 48px 20px;
    color: var(--text-secondary);
  }

  .empty-clues svg {
    width: 40px;
    height: 40px;
    margin-bottom: 12px;
    color: var(--text-muted);
  }

  /* Clickable legend */
  .legend-item.clickable {
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 6px;
    transition: all 0.15s ease;
  }

  .legend-item.clickable:hover {
    background: var(--bg-hover);
  }

  .legend-item.clickable.active {
    background: var(--accent);
    color: white;
  }

  .legend-color.all {
    background: linear-gradient(135deg, #3b82f6 0%, #22c55e 25%, #f59e0b 50%, #a855f7 75%, #64748b 100%);
  }

  .waterfall-row.hidden {
    display: none;
  }

  .span-detail.hidden-by-filter {
    display: none !important;
  }

  .collapse-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
    background: var(--bg-body);
    border: 1px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .collapse-btn:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
    border-color: var(--text-muted);
  }
</style>

<%
  # Helper to get span type category
  def span_category(span)
    name = span[:name].to_s.downcase
    case name
    when /sql\.active_record/, /mysql/, /postgres/, /sqlite/
      "sql"
    when /cache/
      "cache"
    when /render/, /view/
      "view"
    when /http/, /net_http/, /faraday/
      "http"
    when /mail/
      "mailer"
    when /job/, /active_job/
      "job"
    when /action_controller/, /process_action/
      "controller"
    else
      "other"
    end
  end

  # Get root span properties
  root_props = @root_span ? @root_span[:properties] : {}
  job_class = root_props["code.namespace"]
  queue_name = root_props["messaging.destination"]
  job_id = root_props["messaging.message.id"] || root_props["messaging.message_id"]

  # Calculate total duration from root span
  total_duration_ms = @root_span ? @root_span[:duration_ms] : 1
  root_start = @root_span ? @root_span[:start_timestamp] : 0
  started_at = @root_span ? Time.at(@root_span[:start_timestamp] / 1_000_000_000.0) : nil

  # Extract job name from span name (e.g., "MyJob process" -> "MyJob")
  job_display_name = job_class || @job[:name].to_s.sub(/ (process|publish)$/, '')

  # Count span categories
  span_counts = @child_spans.each_with_object(Hash.new(0)) do |span, counts|
    counts[span_category(span)] += 1
  end
%>

<div class="page-header">
  <div class="detail-header">
    <div class="detail-header-left">
      <div class="detail-title">
        <span class="badge badge-job">Job</span>
        <h1><%= job_display_name %></h1>
      </div>
      <div class="detail-meta">
        <div class="meta-item">
          <span class="meta-label">Duration</span>
          <span class="meta-value mono"><%= format_duration(total_duration_ms) %></span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Time</span>
          <span class="meta-value"><%= started_at&.strftime("%b %d, %Y %H:%M:%S") %></span>
        </div>
        <% if queue_name %>
          <div class="meta-item">
            <span class="meta-label">Queue</span>
            <span class="meta-value"><%= queue_name %></span>
          </div>
        <% end %>
        <% if job_id %>
          <div class="meta-item">
            <span class="meta-label">Job ID</span>
            <span class="meta-value mono"><%= job_id %></span>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="card">
    <div class="tabs">
      <a class="tab active" onclick="showTab('timeline')">Timeline (<%= @child_spans.size %>)</a>
      <a class="tab" onclick="showTab('details')">Details</a>
    </div>

    <div id="tab-details" class="tab-content">
      <%
        # Properties to exclude from "other" section (already shown elsewhere)
        shown_keys = %w[code.namespace messaging.destination messaging.message.id messaging.message_id]
        other_props = root_props.reject { |k, v| shown_keys.include?(k) || v.is_a?(Hash) || v.is_a?(Array) }
      %>
      <div class="details-sections">
        <!-- Job Section -->
        <div class="details-section">
          <div class="section-header">
            <div class="section-icon job">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
              </svg>
            </div>
            <span class="section-title">Job</span>
          </div>
          <div class="section-grid">
            <div class="detail-item">
              <span class="detail-label">Duration</span>
              <span class="detail-value prominent"><%= format_duration(total_duration_ms) %></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Time</span>
              <span class="detail-value"><%= started_at&.strftime("%b %d, %Y at %H:%M:%S") %></span>
            </div>
            <% if job_class %>
              <div class="detail-item">
                <span class="detail-label">Job Class</span>
                <span class="detail-value mono"><%= job_class %></span>
              </div>
            <% end %>
            <% if job_id %>
              <div class="detail-item full-width">
                <span class="detail-label">Job ID</span>
                <span class="detail-value mono secondary"><%= job_id %></span>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Queue Section -->
        <% if queue_name %>
          <div class="details-section">
            <div class="section-header">
              <div class="section-icon queue">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="8" y1="6" x2="21" y2="6"></line>
                  <line x1="8" y1="12" x2="21" y2="12"></line>
                  <line x1="8" y1="18" x2="21" y2="18"></line>
                  <line x1="3" y1="6" x2="3.01" y2="6"></line>
                  <line x1="3" y1="12" x2="3.01" y2="12"></line>
                  <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
              </div>
              <span class="section-title">Queue</span>
            </div>
            <div class="section-grid">
              <div class="detail-item">
                <span class="detail-label">Queue Name</span>
                <span class="detail-value mono"><%= queue_name %></span>
              </div>
            </div>
          </div>
        <% end %>

        <!-- Other Properties Section -->
        <% if other_props.any? %>
          <div class="details-section">
            <div class="section-header">
              <div class="section-icon other">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="1"></circle>
                  <circle cx="19" cy="12" r="1"></circle>
                  <circle cx="5" cy="12" r="1"></circle>
                </svg>
              </div>
              <span class="section-title">Additional Properties</span>
            </div>
            <div class="section-grid">
              <% other_props.each do |key, value| %>
                <div class="detail-item">
                  <span class="detail-label"><%= key.to_s.split(".").last.titleize %></span>
                  <span class="detail-value mono truncate" title="<%= value %>"><%= value %></span>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <% if root_props.blank? %>
          <div class="details-section">
            <div class="empty-clues" style="padding: 20px;">
              <p>No details recorded.</p>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div id="tab-timeline" class="tab-content active">
      <% if @child_spans.blank? %>
        <div class="empty-clues">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          <p>No timeline events recorded for this job.</p>
        </div>
      <% else %>
        <div class="legend">
          <div class="legend-item clickable active" data-filter="all" onclick="filterSpans('all')"><div class="legend-color all"></div> All (<%= @child_spans.size %>)</div>
          <% if span_counts["sql"] > 0 %><div class="legend-item clickable" data-filter="sql" onclick="filterSpans('sql')"><div class="legend-color sql"></div> SQL (<%= span_counts["sql"] %>)</div><% end %>
          <% if span_counts["cache"] > 0 %><div class="legend-item clickable" data-filter="cache" onclick="filterSpans('cache')"><div class="legend-color cache"></div> Cache (<%= span_counts["cache"] %>)</div><% end %>
          <% if span_counts["view"] > 0 %><div class="legend-item clickable" data-filter="view" onclick="filterSpans('view')"><div class="legend-color view"></div> View (<%= span_counts["view"] %>)</div><% end %>
          <% if span_counts["http"] > 0 %><div class="legend-item clickable" data-filter="http" onclick="filterSpans('http')"><div class="legend-color http"></div> HTTP (<%= span_counts["http"] %>)</div><% end %>
          <% if span_counts["mailer"] > 0 %><div class="legend-item clickable" data-filter="mailer" onclick="filterSpans('mailer')"><div class="legend-color mailer"></div> Mailer (<%= span_counts["mailer"] %>)</div><% end %>
          <% if span_counts["job"] > 0 %><div class="legend-item clickable" data-filter="job" onclick="filterSpans('job')"><div class="legend-color job"></div> Job (<%= span_counts["job"] %>)</div><% end %>
          <% if span_counts["controller"] > 0 %><div class="legend-item clickable" data-filter="controller" onclick="filterSpans('controller')"><div class="legend-color controller"></div> Controller (<%= span_counts["controller"] %>)</div><% end %>
          <% if span_counts["other"] > 0 %><div class="legend-item clickable" data-filter="other" onclick="filterSpans('other')"><div class="legend-color other"></div> Other (<%= span_counts["other"] %>)</div><% end %>
          <div style="margin-left: auto;">
            <button type="button" onclick="collapseAll()" class="collapse-btn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="4 14 10 14 10 20"></polyline>
                <polyline points="20 10 14 10 14 4"></polyline>
                <line x1="14" y1="10" x2="21" y2="3"></line>
                <line x1="3" y1="21" x2="10" y2="14"></line>
              </svg>
              Collapse All
            </button>
          </div>
        </div>

        <div style="padding: 12px;">
          <div class="waterfall-header">
            <div>Event</div>
            <div>Duration</div>
          </div>

          <div class="waterfall">
            <% @child_spans.each_with_index do |span, index| %>
              <%
                offset_ns = span[:start_timestamp] - root_start
                offset_ms = offset_ns / 1_000_000.0
                left = (offset_ms / [total_duration_ms, 1].max * 100).clamp(0, 99.5)
                width = (span[:duration_ms] / [total_duration_ms, 1].max * 100).clamp(0.5, [0.5, 100 - left].max)
                category = span_category(span)

                # Generate display name
                props = span[:properties] || {}
                sql_statement = nil
                display_name = if span[:name] == "instantiation.active_record"
                  # Show "User Instantiation (23)" format
                  class_name = props["class_name"] || "Record"
                  count = props["record_count"]
                  count ? "#{class_name} Instantiation (#{count})" : "#{class_name} Instantiation"
                elsif category == "sql"
                  sql_statement = props["db.statement"]
                  props["name"] || span[:name]
                elsif category == "cache"
                  key = props["key"]
                  op = span[:name].to_s.sub(".active_support", "").sub("cache_", "")
                  key ? "#{op}: #{key.to_s.truncate(80)}" : span[:name]
                elsif category == "view"
                  identifier = props["identifier"] || props["code.filepath"]
                  if identifier
                    identifier.to_s.sub(/^.*\/app\/views\//, "")
                  else
                    span[:name]
                  end
                elsif category == "http"
                  url = props["http.url"] || props["http.target"]
                  method = props["http.method"]
                  "#{method} #{url}".strip.presence || span[:name]
                elsif category == "controller"
                  ns = props["code.namespace"]
                  fn = props["code.function"]
                  ns && fn ? "#{ns}##{fn}" : span[:name]
                else
                  span[:name]
                end
              %>
              <div class="waterfall-row" onclick="toggleSpan(<%= index %>)" id="row-<%= index %>" data-span-type="<%= category %>" <% if sql_statement.present? %>data-sql="<%= sql_statement.truncate(500).gsub('"', "'") %>"<% end %>>
                <div class="waterfall-bar-container">
                  <div class="waterfall-bar <%= category %>" style="left: <%= left %>%; width: <%= width %>%;"></div>
                  <span class="waterfall-label"><%= display_name %></span>
                  <span class="waterfall-duration"><%= format_duration(span[:duration_ms]) %></span>
                </div>
              </div>
              <div class="span-detail <%= category %>" id="span-<%= index %>">
                <pre><code><%= format_content(span[:properties]) %></code></pre>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    event.target.classList.add('active');
  }

  function toggleSpan(index) {
    const detail = document.getElementById('span-' + index);
    const row = document.getElementById('row-' + index);

    if (detail.classList.contains('visible')) {
      detail.classList.remove('visible');
      row.classList.remove('selected');
    } else {
      detail.classList.add('visible');
      row.classList.add('selected');
    }
  }

  function collapseAll() {
    document.querySelectorAll('.span-detail.visible').forEach(el => {
      el.classList.remove('visible');
    });
    document.querySelectorAll('.waterfall-row.selected').forEach(el => {
      el.classList.remove('selected');
    });
  }

  function filterSpans(filterType) {
    document.querySelectorAll('.legend-item.clickable').forEach(el => {
      el.classList.remove('active');
    });
    document.querySelector('.legend-item[data-filter="' + filterType + '"]').classList.add('active');

    document.querySelectorAll('.waterfall-row').forEach(row => {
      const spanType = row.getAttribute('data-span-type');
      if (filterType === 'all' || spanType === filterType) {
        row.classList.remove('hidden');
      } else {
        row.classList.add('hidden');
        row.classList.remove('selected');
      }
    });

    document.querySelectorAll('.span-detail').forEach(detail => {
      const index = detail.id.replace('span-', '');
      const row = document.getElementById('row-' + index);
      if (row.classList.contains('hidden')) {
        detail.classList.add('hidden-by-filter');
        detail.classList.remove('visible');
      } else {
        detail.classList.remove('hidden-by-filter');
      }
    });
  }

  // SQL tooltip
  document.addEventListener('DOMContentLoaded', () => {
    const sqlTooltip = document.getElementById('sql-tooltip');
    let tooltipTimeout;

    document.querySelectorAll('.waterfall-row[data-sql]').forEach(row => {
      row.addEventListener('mouseenter', () => {
        const sql = row.getAttribute('data-sql');
        if (sql && !row.classList.contains('selected')) {
          tooltipTimeout = setTimeout(() => {
            sqlTooltip.textContent = sql;
            sqlTooltip.classList.add('visible');
          }, 200);
        }
      });

      row.addEventListener('mouseleave', () => {
        clearTimeout(tooltipTimeout);
        sqlTooltip.classList.remove('visible');
      });
    });
  });
</script>

<div id="sql-tooltip"></div>
